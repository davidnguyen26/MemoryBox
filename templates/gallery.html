{% extends "base.html" %}

{% block og_title %}Gallery - MemoryBox{% endblock %}
{% block og_description %}Explore class memories of A4K53 Van Lam High School in the MemoryBox photo gallery.{% endblock %}
{% block og_url %}/gallery{% endblock %}
{% block twitter_title %}Gallery - MemoryBox{% endblock %}
{% block twitter_description %}Explore A4K53 class memories in MemoryBox.{% endblock %}
{% block canonical_url %}/gallery{% endblock %}

{% block title %}Gallery - MemoryBox{% endblock %}

{% block extra_css %}
<link rel="preload" href="{{ url_for('static', filename='css/gallery.min.css') }}" as="style"
    onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gallery.min.css') }}">
</noscript>
{% endblock %}

{% block content %}
<div class="gallery-container">
    <div class="gallery-header">
        <h1 class="gallery-title">Our memories</h1>
        <p class="gallery-subtitle">{{ photos|length }} memorable moments of A4K53 Van Lam High School</p>
    </div>

    {% if photos %}
    <div class="photos-grid">
        {% for photo in photos %}
        <div class="photo-card" onclick="openLightbox({{ loop.index0 }})"
            style="flex-basis: {{ (200 + (photo.id % 100)) }}px;">
            <div class="photo-image-wrapper">
                <img src="{{ url_for('uploaded_file', filename=photo.filename|replace('.jpg', '_thumb.jpg')) }}"
                    data-full="{{ url_for('uploaded_file', filename=photo.filename) }}" srcset="{{ url_for('uploaded_file', filename=photo.filename|replace('.jpg', '_thumb.jpg')) }} 300w,
                     {{ url_for('uploaded_file', filename=photo.filename) }} 1920w"
                    sizes="(max-width: 768px) 100vw, 33vw" alt="{{ photo.caption or 'Photo by' }}" class="photo-image"
                    loading="lazy" decoding="async">
            </div>

            <div class="photo-overlay">
                <div class="photo-top-info">
                    <div class="photo-user">
                        <div class="user-avatar" style="background: {{ photo.uploader.avatar_color }}"
                            data-user-id="{{ photo.uploader.id }}">
                            {% if photo.uploader.avatar_filename %}
                            <img src="{{ url_for('avatar_file', filename=photo.uploader.avatar_filename) }}"
                                alt="{{ photo.uploader.username }}" loading="lazy">
                            {% else %}
                            <span>{{ photo.uploader.username[0].upper() }}</span>
                            {% endif %}
                        </div>
                        <div class="user-info">
                            <div class="user-name">
                                {{ photo.uploader.username }}
                                {% if photo.uploader.is_verified %}
                                <i class="fa-solid fa-circle-check" style="font-size: 0.75rem;"></i>
                                {% endif %}
                            </div>
                            <div class="user-time">{{ time_ago(photo.upload_time) }}</div>
                        </div>
                    </div>

                    <div class="photo-quick-actions" onclick="event.stopPropagation()">
                        <button class="quick-action-btn" title="Download">
                            <a href="{{ url_for('uploaded_file', filename=photo.filename) }}" download
                                style="color: inherit; text-decoration: none;">
                                <i class="bi bi-download"></i>
                            </a>
                        </button>
                    </div>
                </div>

                <div class="photo-bottom-info">
                    {% if photo.caption %}
                    <div class="photo-caption">{{ photo.caption }}</div>
                    {% else %}
                    <div></div>
                    {% endif %}

                    <div class="photo-actions" onclick="event.stopPropagation()">
                        <button class="action-btn {% if photo.is_liked_by(current_user.id) %}active{% endif %}"
                            onclick="toggleLike({{ photo.id }}, this)">
                            <i class="bi bi-heart-fill"></i>
                            <span class="like-count">{{ photo.get_like_count() }}</span>
                        </button>
                        <button class="action-btn">
                            <i class="bi bi-chat-fill"></i>
                            <span class="comment-count">0</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <i class="bi bi-images"></i>
        <h3>No photos available</h3>
        <a href="{{ url_for('upload') }}" class="btn btn-primary">
            <i class="bi bi-cloud-upload"></i> Upload your first photo
        </a>
    </div>
    {% endif %}
    {% if pagination.pages > 1 %}
    <div class="gallery-container" style="text-align:center; animation: fadeInUp .6s cubic-bezier(.16,1,.3,1);">
        <div class="pagination" style="
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            padding:12px 20px;
            background:rgba(255,255,255,0.85);
            backdrop-filter:blur(16px);
            border-radius:16px;
            border:1px solid rgba(226,232,240,0.6);
            box-shadow:0 4px 16px rgba(0,0,0,0.06);
            ">
            {% for p in pagination.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
            {% if p %}
            {% if p == pagination.page %}
            <span class="btn btn-secondary disabled"
                style="transform:scale(1.05);box-shadow:0 0 12px rgba(102,126,234,0.4);font-weight:700;">
                {{ p }}
            </span>
            {% else %}
            <a href="{{ url_for('gallery', page=p) }}" class="btn btn-primary">{{ p }}</a>
            {% endif %}
            {% else %}
            <span style="padding:0 8px;color:#94a3b8;">...</span>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>

<!-- Enhanced Lightbox -->
<div class="lightbox-modal" id="lightbox">
    <button class="close-btn" onclick="closeLightbox()">
        <i class="bi bi-x-lg"></i>
    </button>

    <div class="lightbox-wrapper">
        <div class="lightbox-image-section">
            <img id="lightboxImage" src="" alt="" class="lightbox-image">
            <button class="nav-btn prev" onclick="navigateLightbox(-1)">
                <i class="bi bi-chevron-left"></i>
            </button>
            <button class="nav-btn next" onclick="navigateLightbox(1)">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>

        <div class="lightbox-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-user">
                    <div id="sidebarAvatar" class="sidebar-avatar" onclick="goToUserProfile()"></div>
                    <div class="sidebar-user-info">
                        <h3><a href="#" id="sidebarUsernameLink"></a></h3>
                        <p id="sidebarTime"></p>
                    </div>
                </div>
            </div>

            <div class="sidebar-caption" id="sidebarCaption" style="display: none;">
                <p class="caption-text" id="captionText"></p>
            </div>

            <div class="sidebar-stats">
                <div class="stat-item">
                    <i class="bi bi-heart-fill" style="color: #ef4444;"></i>
                    <span id="likeCount">0</span> likes
                </div>
                <div class="stat-item">
                    <i class="bi bi-chat-fill" style="color: #667eea;"></i>
                    <span id="commentCountSidebar">0</span> comments
                </div>
                <div class="stat-item" style="cursor: pointer;" onclick="copyLink()">
                    <i class="bi bi-share-fill" style="color: #3b82f6;"></i> share
                </div>
            </div>

            <div class="sidebar-comments" id="commentsSection">
                <div class="comments-title">Comments</div>
                <div id="commentsList"></div>
            </div>

            <div class="sidebar-form">
                <div class="comment-form">
                    <textarea id="commentInput" class="comment-input" placeholder="Write a comment..."
                        rows="1"></textarea>
                    <button class="comment-submit" onclick="submitComment()">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const photos = {{ photos_json | tojson }};
    let currentPhotoIndex = 0;
    const currentUserId = {{ session.user_id }};
    const isAdmin = {{ 'true' if session.role == 'admin' else 'false' }};

    {% if open_photo_index is not none %}
    document.addEventListener('DOMContentLoaded', () => {
        openLightbox({{ open_photo_index }});
    });
    {% endif %}

    function openLightbox(index) {
        currentPhotoIndex = index;
        updateLightbox();
        document.getElementById('lightbox').classList.add('active');
        document.body.style.overflow = 'hidden';

        const photo = photos[currentPhotoIndex];
        history.pushState({ photoIndex: index }, '', `/gallery/photo/${photo.id}`);
    }

    function closeLightbox() {
        document.getElementById('lightbox').classList.remove('active');
        document.body.style.overflow = '';
        history.pushState({}, '', '/gallery');
    }

    function navigateLightbox(direction) {
        currentPhotoIndex += direction;
        if (currentPhotoIndex < 0) currentPhotoIndex = photos.length - 1;
        if (currentPhotoIndex >= photos.length) currentPhotoIndex = 0;
        updateLightbox();

        const photo = photos[currentPhotoIndex];
        history.pushState({ photoIndex: currentPhotoIndex }, '', `/gallery/photo/${photo.id}`);
    }

    function updateLightbox() {
        const photo = photos[currentPhotoIndex];
        document.getElementById('lightboxImage').src = `/uploads/${photo.filename}`;

        const avatar = document.getElementById('sidebarAvatar');
        avatar.style.background = photo.uploader.avatar_color;
        avatar.dataset.userId = photo.uploader.id;

        // FIX: Thêm phần kiểm tra avatar_filename
        if (photo.uploader.avatar_filename) {
            avatar.innerHTML = `<img src="/avatars/${photo.uploader.avatar_filename}" alt="${photo.uploader.username}" loading="lazy">`;
        } else {
            avatar.textContent = photo.uploader.username[0].toUpperCase();
        }

        let usernameHTML = photo.uploader.username;
        if (photo.uploader.is_verified) {
            usernameHTML += ' <i class="fa-solid fa-circle-check" style="color: #3b82f6; font-size: 0.85rem;"></i>';
        }

        const usernameLink = document.getElementById('sidebarUsernameLink');
        usernameLink.innerHTML = usernameHTML;
        usernameLink.href = `/user/${photo.uploader.id}`;

        const sidebarTimeEl = document.getElementById('sidebarTime');
        sidebarTimeEl.innerHTML = '';
        const clockIcon = document.createElement('i');
        clockIcon.className = 'bi bi-clock';
        sidebarTimeEl.appendChild(clockIcon);
        sidebarTimeEl.appendChild(document.createTextNode(' ' + getTimeAgo(photo.upload_time)));

        const captionSection = document.getElementById('sidebarCaption');
        if (photo.caption) {
            captionSection.style.display = 'block';
            document.getElementById('captionText').textContent = photo.caption;
        } else {
            captionSection.style.display = 'none';
        }

        document.getElementById('likeCount').textContent = photo.like_count;
        loadComments(photo.id);
    }

    function goToUserProfile() {
        const userId = document.getElementById('sidebarAvatar').dataset.userId;
        window.location.href = `/user/${userId}`;
    }

    function getCurrentPhotoUrl() {
        const photo = photos[currentPhotoIndex];
        return `${window.location.origin}/gallery/photo/${photo.id}`;
    }

    function copyLink() {
        const url = getCurrentPhotoUrl();
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(url).then(() => {
                showCopySuccess();
            }).catch(() => {
                fallbackCopyText(url);
            });
        } else {
            fallbackCopyText(url);
        }
    }

    function fallbackCopyText(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            showCopySuccess();
        } catch (err) {
            alert('Link: ' + text);
        }
        document.body.removeChild(textarea);
    }

    function showCopySuccess() {
        const btn = event.target.closest('.share-btn');
        if (!btn) return;
        const originalHTML = btn.innerHTML;
        const originalBg = btn.style.background;
        btn.innerHTML = '<i class="bi bi-check2"></i>';
        btn.style.background = '#10b981';
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.style.background = originalBg;
        }, 2000);
    }

    function toggleShareMenu() {
        const menu = document.getElementById('shareMenu');
        menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
    }

    async function loadComments(photoId) {
        try {
            const response = await fetch(`/photo/${photoId}/comments`);
            const comments = await response.json();

            const commentsList = document.getElementById('commentsList');
            const commentCount = document.getElementById('commentCountSidebar');

            let totalCount = comments.length;
            comments.forEach(c => totalCount += (c.replies ? c.replies.length : 0));
            commentCount.textContent = totalCount;

            if (comments.length === 0) {
                commentsList.innerHTML = `
                <div class="empty-comments">
                    <i class="bi bi-chat-dots"></i>
                    <p>No comments yet</p>
                </div>
            `;
                return;
            }

            commentsList.innerHTML = comments.map(c => renderComment(c)).join('');
        } catch (error) {
            console.error('Error loading comments:', error);
        }
    }

    function renderComment(comment) {
        const canDelete = comment.user.id === currentUserId || isAdmin;
        return `
            <div class="comment" id="comment-${comment.id}">
                <div class="comment-avatar" style="background: ${comment.user.avatar_color}" onclick="window.location.href='/user/${comment.user.id}'">
                    ${comment.user.avatar_filename ?
                `<img src="/avatars/${comment.user.avatar_filename}" alt="${comment.user.username}" loading="lazy">` :
                comment.user.username[0].toUpperCase()
            }
                </div>
                <div class="comment-content">
                    <div class="comment-header">
                        <span class="comment-author">
                            <a href="/user/${comment.user.id}">${comment.user.username}</a>
                            ${comment.user.is_verified ? '<i class="fa-solid fa-circle-check" style="color: #3b82f6; font-size: 0.7rem;"></i>' : ''}
                        </span>
                        <span class="comment-time">${getTimeAgo(comment.created_at)}</span>
                    </div>
                    <div class="comment-text">${escapeHtml(comment.text)}</div>
                    <div class="comment-actions">
                        ${canDelete ? `<button class="comment-action-btn comment-delete" onclick="deleteComment(${comment.id})">Delete</button>` : ''}
                    </div>
                </div>
            </div>
        `;
    }

    async function submitComment() {
        const input = document.getElementById('commentInput');
        const text = input.value.trim();

        if (!text) return;

        const photo = photos[currentPhotoIndex];

        try {
            const response = await fetch(`/photo/${photo.id}/comment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            });

            if (response.ok) {
                input.value = '';
                input.style.height = 'auto';
                loadComments(photo.id);
                photo.comment_count = (photo.comment_count || 0) + 1;
                updateCommentCount(photo.id, photo.comment_count);
            }
        } catch (error) {
            console.error('Error submitting comment:', error);
        }
    }

    async function deleteComment(commentId) {
        if (!confirm('Delete this comment?')) return;

        try {
            const response = await fetch(`/comment/${commentId}/delete`, {
                method: 'DELETE'
            });

            if (response.ok) {
                const photo = photos[currentPhotoIndex];
                loadComments(photo.id);
            }
        } catch (error) {
            console.error('Error deleting comment:', error);
        }
    }

    async function toggleLike(photoId, button) {
        try {
            const response = await fetch(`/photo/${photoId}/like`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            button.classList.toggle('active', data.liked);
            button.querySelector('.like-count').textContent = data.like_count;

            const photo = photos.find(p => p.id === photoId);
            if (photo) photo.like_count = data.like_count;

            if (document.getElementById('lightbox').classList.contains('active')) {
                document.getElementById('likeCount').textContent = data.like_count;
            }
        } catch (error) {
            console.error('Error toggling like:', error);
        }
    }

    function updateCommentCount(photoId, count) {
        const cards = document.querySelectorAll('.photo-card');
        const photoIndex = photos.findIndex(p => p.id === photoId);
        if (photoIndex !== -1 && cards[photoIndex]) {
            const countSpan = cards[photoIndex].querySelector('.comment-count');
            if (countSpan) countSpan.textContent = count;
        }
    }

    function parseServerTime(t) {
        if (!t) return null;
        return new Date(t);
    }

    function getTimeAgo(uploadTime) {
        const uploaded = parseServerTime(uploadTime);
        if (!uploaded || isNaN(uploaded)) return '—';

        const now = new Date();
        const diffMs = now - uploaded;
        const diffMin = Math.floor(diffMs / 60000);
        const diffHour = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHour / 24);

        if (diffMin < 1) return 'Just now';
        if (diffMin < 60) return `${diffMin} min ago`;
        if (diffHour < 24) return `${diffHour} hours ago`;
        if (diffDay < 7) return `${diffDay} days ago`;
        if (diffDay < 30) return `${Math.floor(diffDay / 7)} weeks ago`;
        if (diffDay < 365) return `${Math.floor(diffDay / 30)} months ago`;
        return `${Math.floor(diffDay / 365)} years ago`;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    document.addEventListener('keydown', e => {
        const lightbox = document.getElementById('lightbox');
        if (!lightbox.classList.contains('active')) return;
        const target = e.target;
        if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
            return;
        }
        if (e.key === 'ArrowLeft') navigateLightbox(-1);
        if (e.key === 'ArrowRight') navigateLightbox(1);
        if (e.key === 'Escape') closeLightbox();
    });

    const commentInput = document.getElementById('commentInput');
    commentInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });

    commentInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            submitComment();
        }
    });

    window.addEventListener('popstate', (e) => {
        if (e.state && e.state.photoIndex !== undefined) {
            openLightbox(e.state.photoIndex);
        } else {
            closeLightbox();
        }
    });

    document.addEventListener('DOMContentLoaded', async () => {
        for (let i = 0; i < photos.length; i++) {
            const photo = photos[i];
            try {
                const response = await fetch(`/photo/${photo.id}/comments`);
                const comments = await response.json();
                let totalCount = comments.length;
                comments.forEach(c => totalCount += (c.replies ? c.replies.length : 0));
                photo.comment_count = totalCount;
                updateCommentCount(photo.id, totalCount);
            } catch (error) {
                console.error(`Error loading comment count for photo ${photo.id}:`, error);
            }
        }
    });
</script>
{% endblock %}